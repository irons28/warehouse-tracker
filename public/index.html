<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warehouse Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gray-100">
  <div id="app"></div>
  
  <script>
    const API_URL = window.location.origin;
    
    const app = {
      view: 'scan',
      pallets: [],
      stats: {},
      activityLog: [],
      scanMode: null,
      tempPallet: null,
      searchTerm: '',
      scanner: null,
      
      async init() {
        await this.loadStats();
        await this.loadPallets();
        await this.loadActivity();
        this.render();
      },
      
      async loadPallets() {
        try {
          const res = await fetch(`${API_URL}/api/pallets`);
          this.pallets = await res.json();
        } catch (e) {
          console.error('Error loading pallets:', e);
        }
      },
      
      async loadStats() {
        try {
          const res = await fetch(`${API_URL}/api/stats`);
          this.stats = await res.json();
        } catch (e) {
          console.error('Error loading stats:', e);
        }
      },
      
      async loadActivity() {
        try {
          const res = await fetch(`${API_URL}/api/activity?limit=100`);
          this.activityLog = await res.json();
        } catch (e) {
          console.error('Error loading activity:', e);
        }
      },
      
      async checkIn(customerName, productId, quantity, location) {
        try {
          const res = await fetch(`${API_URL}/api/pallets`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ customer_name: customerName, product_id: productId, quantity, location })
          });
          const data = await res.json();
          alert(data.message || 'Pallet checked in!');
          await this.loadPallets();
          await this.loadStats();
          await this.loadActivity();
          this.render();
        } catch (e) {
          alert('Error checking in pallet');
          console.error(e);
        }
      },
      
      async checkOut(palletId) {
        if (!confirm('Remove entire pallet?')) return;
        try {
          const res = await fetch(`${API_URL}/api/pallets/${palletId}`, { method: 'DELETE' });
          const data = await res.json();
          alert(data.message || 'Pallet checked out!');
          await this.loadPallets();
          await this.loadStats();
          await this.loadActivity();
          this.render();
        } catch (e) {
          alert('Error checking out pallet');
          console.error(e);
        }
      },
      
      async removePartialQuantity(palletId) {
        const pallet = this.pallets.find(p => p.id === palletId);
        if (!pallet) {
          alert('Pallet not found');
          return;
        }
        
        const qtyToRemove = prompt(`Current quantity: ${pallet.quantity}\n\nHow many units to remove?`, '1');
        if (qtyToRemove === null) return;
        
        const qty = parseInt(qtyToRemove);
        if (isNaN(qty) || qty <= 0) {
          alert('Please enter a valid quantity');
          return;
        }
        
        if (qty > pallet.quantity) {
          alert(`Cannot remove ${qty} units. Only ${pallet.quantity} available.`);
          return;
        }
        
        try {
          const res = await fetch(`${API_URL}/api/pallets/${palletId}/remove-quantity`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity_to_remove: qty })
          });
          const data = await res.json();
          alert(data.message || 'Quantity removed!');
          await this.loadPallets();
          await this.loadStats();
          await this.loadActivity();
          this.render();
        } catch (e) {
          alert('Error removing quantity');
          console.error(e);
        }
      },
      
      startScanner(mode) {
        this.scanMode = mode;
        this.render();
        
        setTimeout(() => {
          const html5QrCode = new Html5Qrcode("qr-reader");
          this.scanner = html5QrCode;
          
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
              this.handleScan(decodedText);
              html5QrCode.stop();
            }
          ).catch(err => {
            console.error("Camera error:", err);
            alert("Camera not available. Use manual entry.");
            this.stopScanner();
          });
        }, 100);
      },
      
      handleScan(code) {
        if (this.scanMode === 'checkin-pallet') {
          this.tempPallet = code;
          this.stopScanner();
          setTimeout(() => {
            this.scanMode = 'checkin-location';
            this.render();
            this.startScanner('checkin-location');
          }, 500);
        } else if (this.scanMode === 'checkin-location') {
          this.stopScanner();
          const customerName = prompt('Enter Customer Name:');
          if (!customerName) return;
          const qty = prompt('Enter quantity:', '1');
          if (qty !== null) {
            this.checkIn(customerName, this.tempPallet, parseInt(qty) || 1, code);
          }
          this.scanMode = null;
          this.tempPallet = null;
        } else if (this.scanMode === 'checkout') {
          this.stopScanner();
          this.checkOut(code);
          this.scanMode = null;
        }
      },
      
      stopScanner() {
        if (this.scanner) {
          try {
            this.scanner.stop();
          } catch (e) {
            console.log('Scanner already stopped');
          }
          this.scanner = null;
        }
      },
      
      showManualEntry() {
        const customerName = prompt('Enter Customer Name (e.g., Godbold, Council):');
        if (!customerName) return;
        
        const productId = prompt('Enter Product ID:');
        if (!productId) return;
        
        const quantity = prompt('Enter Quantity:', '1');
        const location = prompt('Enter Location (e.g., A1-L3):');
        
        if (location) {
          this.checkIn(customerName, productId, parseInt(quantity) || 1, location);
        }
      },
      
      render() {
        const filtered = this.pallets.filter(p => 
          p.product_id.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
          p.location.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
          p.customer_name.toLowerCase().includes(this.searchTerm.toLowerCase())
        );
        
        document.getElementById('app').innerHTML = `
          <div class="bg-blue-600 text-white p-4 shadow-lg">
            <h1 class="text-2xl font-bold">Warehouse Tracker</h1>
            <div class="mt-2 text-sm">
              <span class="mr-4">üì¶ ${this.stats.total_pallets || 0} Pallets</span>
              <span class="mr-4">‚úì ${this.stats.occupied_locations || 0} Occupied</span>
              <span>‚ñ° ${(this.stats.total_locations || 480) - (this.stats.occupied_locations || 0)} Available</span>
            </div>
          </div>
          
          <div class="bg-white border-b sticky top-0 z-10 flex">
            <button onclick="app.view='scan'; app.render()" class="flex-1 py-3 ${this.view === 'scan' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'}">
              üì∑ Scan
            </button>
            <button onclick="app.view='inventory'; app.render()" class="flex-1 py-3 ${this.view === 'inventory' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'}">
              üìã Inventory
            </button>
            <button onclick="app.view='history'; app.render()" class="flex-1 py-3 ${this.view === 'history' ? 'bg-blue-50 text-blue-600 border-b-2 border-blue-600' : 'text-gray-600'}">
              üìú History
            </button>
          </div>
          
          <div class="p-4">
            ${this.view === 'scan' ? this.renderScan() : 
              this.view === 'inventory' ? this.renderInventory(filtered) :
              this.renderHistory()}
          </div>
        `;
        
        // Attach search listener after rendering inventory
        if (this.view === 'inventory') {
          this.attachSearchListener();
        }
      },
      
      attachSearchListener() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          // Remove old listeners to prevent duplicates
          const newSearchInput = searchInput.cloneNode(true);
          searchInput.parentNode.replaceChild(newSearchInput, searchInput);
          
          newSearchInput.addEventListener('input', (e) => {
            this.searchTerm = e.target.value;
            const filtered = this.pallets.filter(p => 
              p.product_id.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
              p.location.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
              p.customer_name.toLowerCase().includes(this.searchTerm.toLowerCase())
            );
            
            // Only update the results div, not the search box
            const resultsDiv = document.querySelector('.space-y-2');
            if (resultsDiv) {
              resultsDiv.innerHTML = filtered.length === 0 ? 
                '<div class="text-center text-gray-500 py-8 text-lg">No pallets found</div>' :
                filtered.map(p => `
                  <div class="bg-white p-4 rounded-lg shadow flex justify-between items-start">
                    <div class="flex-1">
                      <h3 class="font-bold text-lg">${p.product_id}</h3>
                      <p class="text-blue-600 font-semibold">üë§ ${p.customer_name}</p>
                      <p class="text-gray-600">üìç ${p.location}</p>
                      <p class="text-sm text-gray-500">Qty: ${p.quantity} ‚Ä¢ ${new Date(p.date_added).toLocaleDateString()}</p>
                    </div>
                    <div class="flex flex-col gap-2">
                      <button onclick="app.removePartialQuantity('${p.id}')" class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600">
                        Remove Qty
                      </button>
                      <button onclick="app.checkOut('${p.id}')" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600">
                        Remove All
                      </button>
                    </div>
                  </div>
                `).join('');
            }
          });
        }
      },
      
      renderScan() {
        if (!this.scanMode) {
          return `
            <div class="space-y-3">
              <button onclick="app.startScanner('checkin-pallet')" class="w-full bg-green-500 text-white p-4 rounded-lg shadow hover:bg-green-600 text-lg">
                ‚úì Check In Pallet
              </button>
              <button onclick="app.startScanner('checkout')" class="w-full bg-red-500 text-white p-4 rounded-lg shadow hover:bg-red-600 text-lg">
                ‚úó Check Out Pallet
              </button>
              <button onclick="app.showManualEntry()" class="w-full bg-gray-500 text-white p-4 rounded-lg shadow hover:bg-gray-600 text-lg">
                ‚úé Manual Entry
              </button>
            </div>
          `;
        } else {
          return `
            <div class="space-y-4">
              <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-bold mb-2 text-lg">
                  ${this.scanMode === 'checkin-pallet' ? 'üì¶ Step 1: Scan Pallet QR Code' : 
                    this.scanMode === 'checkin-location' ? 'üìç Step 2: Scan Location QR Code' : 
                    'üì¶ Scan Pallet to Remove'}
                </h3>
                ${this.tempPallet ? `<p class="text-green-600 font-semibold">‚úì Pallet: ${this.tempPallet}</p>` : ''}
              </div>
              
              <div id="qr-reader" class="border-4 border-blue-500 rounded-lg overflow-hidden"></div>
              
              <button onclick="app.stopScanner(); app.scanMode = null; app.tempPallet = null; app.render()" class="w-full bg-gray-500 text-white p-3 rounded-lg text-lg">
                Cancel
              </button>
            </div>
          `;
        }
      },
      
      renderInventory(pallets) {
        return `
          <div class="mb-4 flex gap-2">
            <input 
              id="search-input"
              type="text" 
              placeholder="Search customer, product or location..." 
              value="${this.searchTerm}"
              class="flex-1 border p-3 rounded text-lg"
            />
            <a href="${API_URL}/api/export" download class="bg-blue-500 text-white px-4 py-3 rounded flex items-center">
              ‚¨á Export
            </a>
          </div>
          
          <div class="space-y-2">
            ${pallets.length === 0 ? 
              '<div class="text-center text-gray-500 py-8 text-lg">No pallets found</div>' :
              pallets.map(p => `
                <div class="bg-white p-4 rounded-lg shadow flex justify-between items-start">
                  <div class="flex-1">
                    <h3 class="font-bold text-lg">${p.product_id}</h3>
                    <p class="text-blue-600 font-semibold">üë§ ${p.customer_name}</p>
                    <p class="text-gray-600">üìç ${p.location}</p>
                    <p class="text-sm text-gray-500">Qty: ${p.quantity} ‚Ä¢ Added: ${new Date(p.date_added).toLocaleDateString()}</p>
                  </div>
                  <div class="flex flex-col gap-2">
                    <button onclick="app.removePartialQuantity('${p.id}')" class="bg-orange-500 text-white px-3 py-2 rounded text-sm hover:bg-orange-600">
                      Remove Qty
                    </button>
                    <button onclick="app.checkOut('${p.id}')" class="bg-red-500 text-white px-3 py-2 rounded text-sm hover:bg-red-600">
                      Remove All
                    </button>
                  </div>
                </div>
              `).join('')
            }
          </div>
        `;
      },
      
      renderHistory() {
        const getActionBadge = (action) => {
          if (action === 'CHECK_IN') return '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-semibold">‚úì Check In</span>';
          if (action === 'CHECK_OUT') return '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs font-semibold">‚úó Check Out</span>';
          if (action === 'PARTIAL_REMOVE') return '<span class="bg-orange-100 text-orange-800 px-2 py-1 rounded text-xs font-semibold">‚Üì Partial Remove</span>';
          return action;
        };
        
        return `
          <div class="mb-4">
            <h2 class="text-xl font-bold text-gray-800">Activity History</h2>
            <p class="text-sm text-gray-600">Last 100 activities</p>
          </div>
          
          <div class="space-y-2">
            ${this.activityLog.length === 0 ? 
              '<div class="text-center text-gray-500 py-8 text-lg">No activity yet</div>' :
              this.activityLog.map(a => `
                <div class="bg-white p-4 rounded-lg shadow">
                  <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                      <h3 class="font-bold text-lg">${a.product_id}</h3>
                      <p class="text-blue-600 font-semibold text-sm">üë§ ${a.customer_name}</p>
                    </div>
                    ${getActionBadge(a.action)}
                  </div>
                  
                  <div class="grid grid-cols-2 gap-2 text-sm mt-2">
                    <div>
                      <span class="text-gray-600">Location:</span>
                      <span class="font-semibold ml-1">${a.location}</span>
                    </div>
                    ${a.action === 'PARTIAL_REMOVE' || a.action === 'CHECK_OUT' ? `
                      <div>
                        <span class="text-gray-600">Removed:</span>
                        <span class="font-semibold ml-1 text-red-600">${a.quantity_changed}</span>
                      </div>
                    ` : ''}
                    ${a.action === 'PARTIAL_REMOVE' ? `
                      <div>
                        <span class="text-gray-600">Before:</span>
                        <span class="font-semibold ml-1">${a.quantity_before}</span>
                      </div>
                      <div>
                        <span class="text-gray-600">After:</span>
                        <span class="font-semibold ml-1">${a.quantity_after}</span>
                      </div>
                    ` : ''}
                    ${a.action === 'CHECK_IN' ? `
                      <div>
                        <span class="text-gray-600">Quantity:</span>
                        <span class="font-semibold ml-1 text-green-600">${a.quantity_after}</span>
                      </div>
                    ` : ''}
                  </div>
                  
                  ${a.notes ? `<p class="text-xs text-gray-500 mt-2 italic">${a.notes}</p>` : ''}
                  
                  <p class="text-xs text-gray-400 mt-2">
                    üìÖ ${new Date(a.timestamp).toLocaleString()}
                  </p>
                </div>
              `).join('')
            }
          </div>
        `;
      }
    };
    
    app.init();
  </script>
</body>
</html>